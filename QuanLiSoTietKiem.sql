CREATE DATABASE QLSTK
USE QLSTK

CREATE TABLE HANMUC 
(	MYKEY INT NOT NULL,
	TIENTOITHIEU MONEY,
	CONSTRAINT PK_HANMUC_KEY PRIMARY KEY (MYKEY)
)

INSERT INTO HANMUC VALUES(1,1000000)

CREATE TABLE LOAITIETKIEM 
(
	LOAITK NVARCHAR(20),
	THANG INT,
	LAISUAT FLOAT(5),
	CONSTRAINT PK_LOAITIETKIEM_LOAITK PRIMARY KEY (LOAITK)
)

CREATE TABLE SOTIETKIEM
(
	MASO CHAR(10) NOT NULL,
	TENKH NVARCHAR(30) NOT NULL,
	DIACHI NVARCHAR(50),
	SOTIENGUI MONEY,
	LOAITK NVARCHAR(20),
	CMND NVARCHAR(30),
	NGAYMOSO SMALLDATETIME,
	NGAYCAPNHAT SMALLDATETIME,
	STATUS NVARCHAR(10),
	CONSTRAINT PK_SOTIETKIEM_MASO PRIMARY KEY (MASO),
	CONSTRAINT FK_SOTIETKIEM_LOAITK FOREIGN KEY (LOAITK) REFERENCES LOAITIETKIEM (LOAITK)
)

CREATE TABLE PHIEUGUITIEN
(
	MASO CHAR(10) NOT NULL,
	TENKH NVARCHAR(30),
	NGAYGUI SMALLDATETIME,
	SOTIENGUI MONEY,
	CONSTRAINT FK_PHIEUGUITIEN_MASO FOREIGN KEY (MASO) REFERENCES SOTIETKIEM (MASO)
)

CREATE TABLE PHIEURUTTIEN
(
	MASO CHAR(10) NOT NULL,
	TENKH NVARCHAR(30),
	NGAYRUT SMALLDATETIME,
	SOTIENRUT MONEY,
	CONSTRAINT FK_PHIEURUTTIEN_MASO FOREIGN KEY (MASO) REFERENCES SOTIETKIEM (MASO)
)
--///////////////////////////
CREATE TRIGGER CHECK_SOTIETKIEM
ON SOTIETKIEM
FOR INSERT
AS
BEGIN
	DECLARE @SOTIENGUI MONEY, @TIENTOITHIEU MONEY
	SELECT @SOTIENGUI = (SELECT SOTIENGUI FROM INSERTED)
	SELECT @TIENTOITHIEU = (SELECT TIENTOITHIEU FROM HANMUC WHERE MYKEY = 1)
	IF (@SOTIENGUI < @TIENTOITHIEU)
	BEGIN
		ROLLBACK TRAN
	END
END
--/////////////////////////////
CREATE TRIGGER CHECK_PHIEUGUITIEN
ON PHIEUGUITIEN
FOR INSERT
AS
BEGIN
	DECLARE @SOTIENGUI MONEY
	SELECT @SOTIENGUI = (SELECT SOTIENGUI FROM INSERTED)
	IF (@SOTIENGUI < 100000)
	BEGIN
		ROLLBACK TRAN
	END
	DECLARE @STATUS NVARCHAR(10)
	SELECT @STATUS = (SELECT STATUS FROM SOTIETKIEM WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED))
	IF (@STATUS = 'CLOSE')
	BEGIN
		ROLLBACK TRAN
	END 
	DECLARE @NGAYGUI SMALLDATETIME, @NGAYCAPNHAT SMALLDATETIME, @CHECK INT, @THANG INT, @LOAITK NVARCHAR(20)
	SELECT @NGAYGUI = (SELECT NGAYGUI FROM INSERTED)
	SELECT @NGAYCAPNHAT = (SELECT NGAYCAPNHAT FROM SOTIETKIEM WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED) AND SOTIETKIEM.TENKH = (SELECT TENKH FROM INSERTED))
	SELECT @CHECK = MONTH(@NGAYGUI) - MONTH(@NGAYCAPNHAT) + (YEAR(@NGAYGUI) - YEAR(@NGAYCAPNHAT))*12
	IF (DAY(@NGAYGUI) < DAY(@NGAYCAPNHAT))
	BEGIN
		SELECT @CHECK = @CHECK - 1
	END
	SELECT @LOAITK = (SELECT LOAITK FROM SOTIETKIEM WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED))
	SELECT @THANG = (SELECT THANG FROM LOAITIETKIEM WHERE LOAITIETKIEM.LOAITK = @LOAITK)
	DECLARE @LAISUAT FLOAT(5)
	IF (@NGAYGUI - @NGAYCAPNHAT < @NGAYCAPNHAT - @NGAYCAPNHAT)
	BEGIN
		ROLLBACK TRAN
	END
	IF (@LOAITK <> N'Không kỳ hạn')
	BEGIN
		IF (@CHECK < @THANG OR @CHECK%@THANG != 0)
		BEGIN
			ROLLBACK TRAN
		END
		IF (DAY(@NGAYGUI) <> DAY(@NGAYCAPNHAT))
		BEGIN
			ROLLBACK TRAN
		END
		SELECT @LAISUAT = (SELECT LAISUAT FROM LOAITIETKIEM WHERE LOAITK = @LOAITK)
		UPDATE SOTIETKIEM
		SET SOTIETKIEM.SOTIENGUI = SOTIETKIEM.SOTIENGUI*(1 + @CHECK*@LAISUAT) + (SELECT SOTIENGUI FROM INSERTED), NGAYCAPNHAT = @NGAYGUI
		WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED)
	END
	IF (@LOAITK = N'Không kỳ hạn')
	BEGIN
		SELECT @LAISUAT = (SELECT LAISUAT FROM LOAITIETKIEM WHERE LOAITK = @LOAITK)
		UPDATE SOTIETKIEM
		SET SOTIETKIEM.SOTIENGUI = SOTIETKIEM.SOTIENGUI*(1 + @CHECK*@LAISUAT) + (SELECT SOTIENGUI FROM INSERTED), NGAYCAPNHAT = @NGAYGUI
		WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED)
	END
END
--/////////////////////////
CREATE TRIGGER CHECK_PHIEURUTTIEN
ON PHIEURUTTIEN
FOR INSERT
AS
BEGIN
	DECLARE @SOTIENRUT MONEY
	SELECT @SOTIENRUT = (SELECT SOTIENRUT FROM INSERTED)
	DECLARE @STATUS NVARCHAR(10)
	SELECT @STATUS = (SELECT STATUS FROM SOTIETKIEM WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED))
	IF (@STATUS = 'CLOSE')
	BEGIN
		ROLLBACK TRAN
	END 
	DECLARE @NGAYRUT SMALLDATETIME, @NGAYCAPNHAT SMALLDATETIME, @CHECK INT, @THANG INT, @LOAITK NVARCHAR(20)
	SELECT @NGAYRUT = (SELECT NGAYRUT FROM INSERTED)
	SELECT @NGAYCAPNHAT = (SELECT NGAYCAPNHAT FROM SOTIETKIEM WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED) AND SOTIETKIEM.TENKH = (SELECT TENKH FROM INSERTED))
	SELECT @CHECK = MONTH(@NGAYRUT) - MONTH(@NGAYCAPNHAT) + (YEAR(@NGAYRUT) - YEAR(@NGAYCAPNHAT))*12
	IF (DAY(@NGAYRUT) < DAY(@NGAYCAPNHAT))
	BEGIN
		SELECT @CHECK = @CHECK - 1
	END
	SELECT @LOAITK = (SELECT LOAITK FROM SOTIETKIEM WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED))
	SELECT @THANG = (SELECT THANG FROM LOAITIETKIEM WHERE LOAITIETKIEM.LOAITK = @LOAITK)
	DECLARE @LAISUAT FLOAT(5), @SOTIENGUI MONEY
	SELECT @SOTIENGUI = (SELECT SOTIENGUI FROM SOTIETKIEM WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED))
	IF (@SOTIENRUT > @SOTIENGUI)
	BEGIN
		ROLLBACK TRAN
	END
	IF (@NGAYRUT - @NGAYCAPNHAT < @NGAYCAPNHAT - @NGAYCAPNHAT)
	BEGIN
		ROLLBACK TRAN
	END
	IF (@LOAITK <> N'Không kỳ hạn')
	BEGIN
		IF (@CHECK < @THANG)
		BEGIN
			ROLLBACK TRAN
		END
		SELECT @LAISUAT = (SELECT LAISUAT FROM LOAITIETKIEM WHERE LOAITK = @LOAITK)
		UPDATE PHIEURUTTIEN
		SET SOTIENRUT = @SOTIENGUI*(1 + @CHECK/@THANG*@THANG*@LAISUAT)
		WHERE PHIEURUTTIEN.MASO = (SELECT MASO FROM INSERTED)
		UPDATE SOTIETKIEM
		SET SOTIETKIEM.SOTIENGUI = 0, NGAYCAPNHAT = @NGAYRUT, STATUS = 'CLOSE'
		WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED)
	END
	IF (@LOAITK = N'Không kỳ hạn')
	BEGIN
		DECLARE @DAYCHECK INT
		SELECT @DAYCHECK = DAY(@NGAYRUT) - DAY(@NGAYCAPNHAT) + (MONTH(@NGAYRUT)-MONTH(@NGAYCAPNHAT))*30 + (YEAR(@NGAYRUT)-YEAR(@NGAYCAPNHAT))*365
		IF (@DAYCHECK < 15)
		BEGIN
			ROLLBACK TRAN
		END
		SELECT @LAISUAT = (SELECT LAISUAT FROM LOAITIETKIEM WHERE LOAITK = @LOAITK)
		UPDATE SOTIETKIEM
		SET SOTIETKIEM.SOTIENGUI = SOTIETKIEM.SOTIENGUI*(1 + @CHECK*@LAISUAT) - (SELECT SOTIENRUT FROM INSERTED), NGAYCAPNHAT = @NGAYRUT
		WHERE SOTIETKIEM.MASO = (SELECT MASO FROM INSERTED)
	END
END
--//////////////////////////
INSERT INTO LOAITIETKIEM VALUES (N'Không kỳ hạn', 0, 0.0015)
INSERT INTO LOAITIETKIEM VALUES (N'3 tháng', 3, 0.005)
INSERT INTO LOAITIETKIEM VALUES (N'6 tháng', 6, 0.0055)
--/////////////////////////
INSERT INTO SOTIETKIEM VALUES (1, N'Nguyễn Văn An', N'1 Nguyễn Huệ thành phố Thủ Đức', 1000000, N'Không kỳ hạn', N'0001', '1/12/2023', '1/12/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (2, N'Chu Thị Hồng', N'23 Quang Trung thành phố Thủ Đức', 1500000, N'Không kỳ hạn', N'0002', '3/1/2023', '3/1/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (3, N'Nguyễn Trọng Luân', N'344 Nguyễn Huệ thành phố Thủ Đức', 1600000, N'Không kỳ hạn', N'0003', '4/23/2023', '4/23/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (4, N'Trần Văn Huy', N'42 Nguyễn Trãi thành phố Thủ Đức', 2000000, N'Không kỳ hạn', N'0004', '1/1/2023', '1/1/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (5, N'Lưu Hoài Tấn', N'5 Lê Lợi thành phố Thủ Đức', 2300000, N'Không kỳ hạn', N'0005', '8/24/2023', '8/24/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (6, N'Nguyễn Thị Chi', N'336 Nguyễn Trọng Tấn thành phố Thủ Đức', 2700000, N'Không kỳ hạn', N'0006', '7/8/2023', '7/8/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (7, N'Trần Thị Mỹ Duyên', N'73 Nguyễn Huệ thành phố Thủ Đức', 1300000, N'Không kỳ hạn', N'0007', '7/11/2023', '7/11/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (8, N'Võ Nguyên Sơn', N'28 Nguyễn Huệ thành phố Thủ Đức', 17000000, N'3 tháng', N'0008', '4/1/2023', '4/1/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (9, N'Võ Trọng An', N'59 Lê Lợi thành phố Thủ Đức', 24000000, N'3 tháng', N'0009', '8/15/2023', '8/15/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (10, N'Chu Văn Sơn', N'120 Nguyễn Trọng Tấn thành phố Thủ Đức', 2200000, N'3 tháng', N'0010', '10/22/2023', '10/22/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (11, N'Nguyễn Trãi', N'111 Nguyễn Huệ thành phố Thủ Đức', 3400000, N'3 tháng', N'0011', '2/4/2023', '2/4/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (12, N'Lê Quý Đôn', N'123 Lê Lợi thành phố Thủ Đức', 4500000, N'3 tháng', N'0012', '4/2/2023', '4/2/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (13, N'Trần Hưng Đạo', N'113 Quang Trung thành phố Thủ Đức', 5000000, N'3 tháng', N'0013', '11/29/2023', '11/29/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (14, N'Nguyễn Huệ', N'164 Nguyễn Trãi thành phố Thủ Đức', 4300000, N'3 tháng', N'0014', '12/25/2023', '12/25/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (15, N'Lê Huy Hoàng', N'115 Nguyễn Huệ thành phố Thủ Đức', 2400000, N'6 tháng', N'0015', '2/8/2023', '2/8/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (16, N'Võ Văn Tần', N'16 Nguyễn Trọng Tấn thành phố Thủ Đức', 8900000, N'6 tháng', N'0016', '3/6/2023', '3/6/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (17, N'Trần Trọng Khôi', N'197 Nguyễn Huệ thành phố Thủ Đức', 7400000, N'6 tháng', N'0017', '11/13/2023', '11/13/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (18, N'Dương Hoàng Long', N'418 Quang Trung thành phố Thủ Đức', 8700000, N'6 tháng', N'0018', '10/6/2023', '10/6/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (19, N'Võ Minh Dương', N'193 Nguyễn Trọng Tấn thành phố Thủ Đức', 5500000, N'6 tháng', N'0019', '2/11/2023', '2/11/2023', 'OPEN')
INSERT INTO SOTIETKIEM VALUES (20, N'Dương Thị Quá', N'240 Lê Lợi thành phố Thủ Đức', 8500000, N'6 tháng', N'0020', '5/5/2023', '5/5/2023', 'OPEN')

INSERT INTO PHIEUGUITIEN VALUES (1, N'Nguyễn Văn An', '2/15/2023', 2000000)
INSERT INTO PHIEUGUITIEN VALUES (2, N'Chu Thị Hồng', '5/11/2023', 340000)
INSERT INTO PHIEUGUITIEN VALUES (9, N'Võ Trọng An', '11/15/2023', 400000)
INSERT INTO PHIEUGUITIEN VALUES (14, N'Nguyễn Huệ', '3/25/2024', 25000000)
INSERT INTO PHIEUGUITIEN VALUES (18, N'Dương Hoàng Long', '4/6/2024', 4500000)

INSERT INTO PHIEURUTTIEN VALUES (4, N'Trần Văn Huy', '6/5/2023', 100000)
INSERT INTO PHIEURUTTIEN VALUES (10, N'Chu Văn Sơn', '11/23/2024', 200000)
INSERT INTO PHIEURUTTIEN VALUES (12, N'Lê Quý Đôn', '12/8/2023', 200000)
INSERT INTO PHIEURUTTIEN VALUES (17, N'Trần Trọng Khôi', '6/9/2023', 200000)
INSERT INTO PHIEURUTTIEN VALUES (20, N'Dương Thị Quá', '12/10/2023', 200000)
